u<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity Tracker - Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
        .tab-content.hidden { display: none; }
        .tab-btn.active { border-color: #1e3a8a; color: #1e3a8a; }
        .navy-btn { background-color: #334155; }
        .navy-btn:hover { background-color: #475569; }
        
        /* Hide number input arrows */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* Fix dropdown z-index issues */
        select {
            position: relative;
            z-index: 10;
        }
        
        /* Ensure form container has proper stacking context */
        #taskForm {
            position: relative;
            z-index: 1;
        }
        
        /* Ensure staff selection area has higher z-index */
        .staff-selection-container {
            position: relative;
            z-index: 20;
        }
        
        /* Drag and drop styles */
        .draggable {
            cursor: default;
        }
        
        .draggable:hover .drag-handle {
            opacity: 1;
        }
        
        .dragging {
            opacity: 0.5;
            cursor: move;
        }
        
        .drop-indicator {
            height: 3px;
            background-color: #3b82f6;
            margin: 2px 0;
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .drop-indicator.active {
            opacity: 1;
        }
        
        .drag-over-category {
            background-color: #eff6ff;
            border-color: #3b82f6;
        }
        
        /* Drag handle icon */
        .drag-handle {
            display: inline-flex;
            flex-direction: column;
            gap: 2px;
            cursor: move;
            color: #9ca3af;
            opacity: 0.5;
            transition: opacity 0.2s ease;
        }
        
        .drag-handle:hover {
            opacity: 1;
        }
        
        .drag-handle svg {
            width: 16px;
            height: 16px;
        }
        
        /* Time input alignment */
        .time-input-group {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .time-input-group input {
            text-align: right;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <h1 class="text-xl font-semibold text-gray-900">FC&F Workload Manager</h1>
                <button id="adminBtn" class="navy-btn inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                    Admin
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Staff Input Page -->
        <div id="staffInputPage" class="max-w-4xl mx-auto">
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-medium text-gray-900">Daily Task Entry</h2>
                    <p class="mt-1 text-sm text-gray-600">Enter your task counts for the selected date</p>
                </div>

                <form id="taskForm" class="p-6">
                    <!-- Staff and Date Selection -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="staff-selection-container">
                            <label for="staff" class="block text-sm font-medium text-gray-700 mb-2">Staff Member</label>
                            <select id="staff" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Select staff member</option>
                                <option value="stevie">Stevie</option>
                                <option value="chloe">Chloe</option>
                                <option value="hunter">Hunter</option>
                                <option value="swetha">Swetha</option>
                                <option value="tharaka">Tharaka</option>
                            </select>
                        </div>
                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                            <input type="date" id="date" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                    </div>

                    <!-- Task Categories -->
                    <div id="taskCategories" class="space-y-8">
                        <!-- Categories will be populated by JavaScript -->
                    </div>


                    <!-- Submit Button -->
                    <div class="mt-8 flex justify-end">
                        <button type="submit" id="submitBtn" class="navy-btn px-6 py-2 text-white font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300">
                            Save Entry
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="adminPage" class="hidden">
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-medium text-gray-900">Admin Dashboard</h2>
                        <button id="backBtn" class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                            ‚Üê Back to Entry
                        </button>
                    </div>
                    
                    <!-- Tab Navigation -->
                    <div class="mt-4">
                        <nav class="flex space-x-8">
                            <button class="tab-btn active whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm transition-colors" data-tab="team-output">
                                Team Output
                            </button>
                            <button class="tab-btn whitespace-nowrap py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors" data-tab="task-calibration">
                                Task Calibration
                            </button>
                            <button class="tab-btn whitespace-nowrap py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors" data-tab="staff-management">
                                Staff Management
                            </button>
                        </nav>
                    </div>
                </div>

                <div class="p-6">
                    <!-- Team Output Tab -->
                    <div id="team-output" class="tab-content">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Team Output</h3>
                        <p class="text-sm text-gray-600 mb-4">View completed tasks with calculated time and productivity ratios. Only shows tasks that were actually completed (count > 0).</p>

                        <!-- Filters -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Today's Date</label>
                                <input type="date" id="todayDate" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Staff Member</label>
                                <select id="staffFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">All Staff</option>
                                    <option value="Stevie">Stevie</option>
                                    <option value="Chloe">Chloe</option>
                                    <option value="Hunter">Hunter</option>
                                    <option value="Swetha">Swetha</option>
                                    <option value="Tharaka">Tharaka</option>
                                </select>
                            </div>
                        </div>

                        <!-- Team Output Results -->
                        <div id="teamOutputResults">
                            <!-- Results will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Task Calibration Tab -->
                    <div id="task-calibration" class="tab-content hidden">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Task Calibration</h3>
                        <p class="text-sm text-gray-600 mb-4">Manage task durations and categories. Changes will affect future time calculations.</p>
                        
                        <!-- Add New Task and Category Buttons -->
                        <div class="mb-6 flex gap-3">
                            <button onclick="showAddTaskModal()" class="bg-[#334155] text-white px-4 py-2 rounded hover:bg-[#1e293b] transition-colors">
                                Add New Task
                            </button>
                            <button onclick="showCreateCategoryModal()" class="bg-[#334155] text-white px-4 py-2 rounded hover:bg-[#1e293b] transition-colors">
                                Create Category
                            </button>
                        </div>
                        
                        <!-- Tasks List -->
                        <div id="taskCalibrationList" class="space-y-6">
                            <!-- Tasks will be rendered here -->
                        </div>
                    </div>

                    <!-- Staff Management Tab -->
                    <div id="staff-management" class="tab-content hidden">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Staff Management</h3>
                        <p class="text-sm text-gray-600 mb-4">Add or remove staff members from the system.</p>
                        
                        <!-- Add Staff Form -->
                        <div class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                            <h4 class="font-semibold text-gray-700 mb-3">Add New Staff Member</h4>
                            <form id="addStaffForm" class="flex gap-3">
                                <input type="text" id="newStaffName" placeholder="Enter staff name" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                                       required>
                                <button type="submit" class="navy-btn px-4 py-2 text-white font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                    Add Staff
                                </button>
                            </form>
                        </div>
                        
                        <!-- Staff List -->
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">Current Staff Members</h4>
                            <div id="staffList" class="space-y-2">
                                <!-- Staff list will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Task Modal -->
    <div id="addTaskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-96">
            <h3 class="text-lg font-semibold mb-4">Add New Task</h3>
            <form id="addTaskForm" onsubmit="handleAddTask(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select id="newTaskCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="">Select category</option>
                        <option value="ONBOARDING">ONBOARDING</option>
                        <option value="FRAUD">FRAUD</option>
                        <option value="UMR'S">UMR'S</option>
                        <option value="TRANSACTION MONITORING">TRANSACTION MONITORING</option>
                        <option value="ADMIN">ADMIN</option>
                        <option value="LENDING">LENDING</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Task Name</label>
                    <input type="text" id="newTaskName" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Expected Duration (minutes)</label>
                    <input type="number" id="newTaskDuration" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="hideAddTaskModal()" class="px-4 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-[#334155] text-white rounded-md hover:bg-[#1e293b] transition-colors">
                        Add Task
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Category Modal -->
    <div id="createCategoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-96">
            <h3 class="text-lg font-semibold mb-4">Create New Category</h3>
            <form id="createCategoryForm" onsubmit="handleCreateCategory(event)">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category Name</label>
                    <input type="text" id="newCategoryName" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="hideCreateCategoryModal()" class="px-4 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-md transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-[#334155] text-white rounded-md hover:bg-[#1e293b] transition-colors">
                        Create Category
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Task data with all categories and durations
        const tasks = {
            'ONBOARDING': [
                { id: '1', name: 'Manual reviews', duration: 30 },
                { id: '2', name: 'Ownership reviews', duration: 25 },
                { id: '3', name: 'Blocklist hits', duration: 15 },
                { id: '4', name: 'ECDD', duration: 45 },
                { id: '5', name: 'KYC refresh', duration: 20 },
                { id: '6', name: 'Manual KYC Verification', duration: 35 }
            ],
            'FRAUD': [
                { id: '7', name: 'Fraud queue - Card', duration: 20 },
                { id: '8', name: 'Fraud queue - Transfer', duration: 25 },
                { id: '9', name: 'Fraud Reports (in and out)', duration: 30 },
                { id: '10', name: 'Indemnities', duration: 40 },
                { id: '11', name: 'Feedzai Failure Reconciliation', duration: 15 },
                { id: '12', name: 'AFCX Upload', duration: 10 },
                { id: '13', name: 'Fraud hotline', duration: 25 }
            ],
            'UMR\'S': [
                { id: '15', name: 'MCL', duration: 30 },
                { id: '16', name: 'Fraud', duration: 25 },
                { id: '17', name: 'TM', duration: 20 },
                { id: '18', name: 'Lending', duration: 35 },
                { id: '19', name: 'Offboarding', duration: 30 },
                { id: '20', name: 'QA', duration: 25 },
                { id: '21', name: 'LEA/NTP', duration: 45 }
            ],
            'TRANSACTION MONITORING': [
                { id: '22', name: 'Transaction Monitoring', duration: 30 }
            ],
            'ADMIN': [
                { id: '23', name: 'Ops support', duration: 20 },
                { id: '24', name: 'Reporting (DFAT, FCC reports etc).', duration: 60 },
                { id: '25', name: 'Project Work', duration: 120 }
            ],
            'LENDING': [
                { id: '26', name: 'Lending app review', duration: 40 },
                { id: '27', name: 'Lending app QA', duration: 30 }
            ]
        };

        // Mock data for team output (simulating saved entries)
        let savedEntries = [
            { staff: 'Stevie', date: '2024-08-24', taskId: '1', count: 5 },
            { staff: 'Stevie', date: '2024-08-24', taskId: '7', count: 8 },
            { staff: 'Stevie', date: '2024-08-24', taskId: '22', count: 3 },
            { staff: 'Chloe', date: '2024-08-24', taskId: '4', count: 4 },
            { staff: 'Chloe', date: '2024-08-24', taskId: '10', count: 3 },
            { staff: 'Hunter', date: '2024-08-23', taskId: '25', count: 2 },
            { staff: 'Hunter', date: '2024-08-23', taskId: '26', count: 6 }
        ];
        
        // Staff members list (simulating database)
        let staffMembers = [
            { id: 'stevie', name: 'Stevie', active: true },
            { id: 'chloe', name: 'Chloe', active: true },
            { id: 'hunter', name: 'Hunter', active: true },
            { id: 'swetha', name: 'Swetha', active: true },
            { id: 'tharaka', name: 'Tharaka', active: true }
        ];

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            
            // Set today's date for admin filter
            document.getElementById('todayDate').value = today;

            // Render task categories
            renderTaskCategories();
            
            // Set up event listeners
            setupEventListeners();
            
            // Set up staff and date change listeners
            document.getElementById('staff').addEventListener('change', loadExistingData);
            document.getElementById('date').addEventListener('change', loadExistingData);
            
            // Initial team output render
            renderTeamOutput();
            
            // Initial staff list render
            renderStaffList();
            
            // Set up staff management form
            document.getElementById('addStaffForm').addEventListener('submit', handleAddStaff);
        }

        function renderTaskCategories() {
            const container = document.getElementById('taskCategories');
            container.innerHTML = '';

            Object.entries(tasks).forEach(([category, categoryTasks]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'border border-gray-200 rounded-lg p-4';
                
                categoryDiv.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-900 mb-3 bg-gray-50 px-3 py-2 rounded">${category}</h3>
                    <div class="space-y-2">
                        ${categoryTasks.map(task => `
                            <div class="flex items-center justify-between py-2 px-3 bg-white border border-gray-100 rounded">
                                <label for="task-${task.id}" class="text-sm font-medium text-gray-700 flex-1">${task.name}</label>
                                <input type="number" id="task-${task.id}" min="0" value="" 
                                       class="task-input w-16 px-2 py-1 text-center border border-gray-300 rounded focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="" data-task-id="${task.id}" data-duration="${task.duration}">
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(categoryDiv);
            });
        }

        function setupEventListeners() {
            // Admin/Back navigation
            document.getElementById('adminBtn').addEventListener('click', showAdminPage);
            document.getElementById('backBtn').addEventListener('click', showStaffInputPage);
            
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
            });
            
            // Task input changes
            document.addEventListener('input', (e) => {
                if (e.target.classList.contains('task-input')) {
                    calculateTotals();
                }
            });
            
            // Form submission
            document.getElementById('taskForm').addEventListener('submit', handleSubmit);
            
            // Admin filters
            document.getElementById('todayDate').addEventListener('change', renderTeamOutput);
            document.getElementById('staffFilter').addEventListener('change', renderTeamOutput);
        }

        function calculateTotals() {
            // Function kept for compatibility but no longer displays summary
            // since the Daily Summary section was removed
        }

        function handleSubmit(e) {
            e.preventDefault();
            
            const staff = document.getElementById('staff').value;
            const date = document.getElementById('date').value;
            
            if (!staff || !date) {
                showMessage('Please select staff member and date', 'error');
                return;
            }
            
            // Collect task counts
            const taskInputs = document.querySelectorAll('.task-input');
            const entries = [];
            
            taskInputs.forEach(input => {
                const count = parseInt(input.value) || 0;
                if (count > 0) {
                    entries.push({
                        staff: getStaffName(staff),
                        date: date,
                        taskId: input.dataset.taskId,
                        count: count
                    });
                }
            });
            
            // Remove existing entries for this staff/date
            savedEntries = savedEntries.filter(entry => 
                !(entry.staff === getStaffName(staff) && entry.date === date)
            );
            
            // Add new entries
            savedEntries.push(...entries);
            
            // Calculate totals for display
            let totalMinutes = 0;
            entries.forEach(entry => {
                const task = findTaskById(entry.taskId);
                totalMinutes += entry.count * task.duration;
            });
            
            // Show success message
            showMessage('Success!', 'success');
            
            // Don't clear form - keep numbers displayed so staff can verify what they entered
            // calculateTotals(); // Keep current totals visible
            
            // Update team output if on admin page
            renderTeamOutput();
        }

        function getStaffName(staffId) {
            const staff = staffMembers.find(s => s.id === staffId);
            return staff ? staff.name : staffId;
        }

        function findTaskById(taskId) {
            for (const category of Object.values(tasks)) {
                const task = category.find(t => t.id === taskId);
                if (task) return task;
            }
            return null;
        }

        function resetTaskInputs() {
            // Clear all task input values
            const taskInputs = document.querySelectorAll('.task-input');
            taskInputs.forEach(input => {
                input.value = '';
            });
        }
        
        function loadExistingData() {
            // First reset all inputs
            resetTaskInputs();
            
            const staff = document.getElementById('staff').value;
            const date = document.getElementById('date').value;
            
            if (!staff || !date) return;
            
            const staffName = getStaffName(staff);
            
            // Find existing entries for this staff/date combination
            const existingEntries = savedEntries.filter(entry => 
                entry.staff === staffName && entry.date === date
            );
            
            // Populate the form with existing data
            existingEntries.forEach(entry => {
                const input = document.getElementById(`task-${entry.taskId}`);
                if (input) {
                    input.value = entry.count;
                }
            });
            
            // Update any totals display if needed
            calculateTotals();
        }

        function showMessage(message, type) {
            if (type === 'success') {
                // Change button text and fade in
                const submitBtn = document.getElementById('submitBtn');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Saved!';
                submitBtn.style.opacity = '0.8';
                
                // Reset after 10 seconds
                setTimeout(() => {
                    submitBtn.textContent = originalText;
                    submitBtn.style.opacity = '1';
                }, 10000);
            } else {
                // Handle error messages (keep existing functionality)
                alert(message);
            }
        }

        function showAdminPage() {
            document.getElementById('staffInputPage').classList.add('hidden');
            document.getElementById('adminPage').classList.remove('hidden');
            renderTeamOutput();
        }

        function showStaffInputPage() {
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('staffInputPage').classList.remove('hidden');
        }

        function switchTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('border-transparent', 'text-gray-500');
                btn.classList.remove('border-blue-500', 'text-blue-600');
            });
            
            const activeBtn = document.querySelector(`[data-tab="${tabId}"]`);
            activeBtn.classList.add('active');
            activeBtn.classList.remove('border-transparent', 'text-gray-500');
            activeBtn.classList.add('border-blue-500', 'text-blue-600');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabId).classList.remove('hidden');
            
            // Refresh staff list when switching to staff management tab
            if (tabId === 'staff-management') {
                renderStaffList();
            }
        }

        function renderTeamOutput() {
            const container = document.getElementById('teamOutputResults');
            const selectedDate = document.getElementById('todayDate').value;
            const selectedStaff = document.getElementById('staffFilter').value;
            
            // Filter entries based on selected date and staff
            let filteredEntries = savedEntries.filter(entry => {
                const matchesDate = !selectedDate || entry.date === selectedDate;
                const matchesStaff = !selectedStaff || entry.staff === selectedStaff;
                return matchesDate && matchesStaff;
            });
            
            if (filteredEntries.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">No data found for the selected filters</div>';
                return;
            }
            
            // Group by staff
            const staffData = {};
            const categoryTotals = {};
            let totalTaskCount = 0;
            
            filteredEntries.forEach(entry => {
                if (!staffData[entry.staff]) {
                    staffData[entry.staff] = {
                        totalMinutes: 0,
                        categories: {},
                        entries: []
                    };
                }
                
                const task = findTaskById(entry.taskId);
                const category = findTaskCategory(entry.taskId);
                
                staffData[entry.staff].totalMinutes += entry.count * task.duration;
                staffData[entry.staff].entries.push({
                    task: task,
                    count: entry.count,
                    category: category
                });
                
                // Track category counts for this staff member
                if (!staffData[entry.staff].categories[category]) {
                    staffData[entry.staff].categories[category] = {
                        tasks: [],
                        totalCount: 0
                    };
                }
                staffData[entry.staff].categories[category].tasks.push({
                    name: task.name,
                    count: entry.count,
                    duration: task.duration
                });
                staffData[entry.staff].categories[category].totalCount += entry.count;
                
                // Track overall category totals
                if (!categoryTotals[category]) {
                    categoryTotals[category] = 0;
                }
                categoryTotals[category] += entry.count;
                totalTaskCount += entry.count;
            });
            
            let html = '';
            
            // Render individual staff sections
            Object.entries(staffData).forEach(([staffName, data]) => {
                const staffTotalTasks = data.entries.reduce((sum, entry) => sum + entry.count, 0);
                const productivity = Math.round((data.totalMinutes / 450) * 100); // 450 minutes = 7.5 hours
                
                html += `
                    <div class="mb-6 bg-white border border-gray-200 rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">${staffName}</h3>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-gray-900">${productivity}%</div>
                                <div class="text-sm text-gray-500">${formatTimeHMM(data.totalMinutes)}</div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                `;
                
                // Render categories for this staff member
                Object.entries(data.categories).forEach(([category, categoryData]) => {
                    const categoryPercentage = ((categoryData.totalCount / staffTotalTasks) * 100);
                    const percentageDisplay = categoryPercentage % 1 === 0 ? categoryPercentage.toFixed(0) : categoryPercentage.toFixed(1);
                    
                    // Calculate total time for this category
                    const categoryTotalTime = categoryData.tasks.reduce((sum, task) => sum + (task.count * task.duration), 0);
                    
                    html += `
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold text-gray-700">${category}</h4>
                                <span class="font-bold text-gray-700">${percentageDisplay}%</span>
                            </div>
                            <div class="ml-4 space-y-1">
                    `;
                    
                    categoryData.tasks.forEach(task => {
                        const taskTime = task.count * task.duration;
                        const taskPercentage = categoryTotalTime > 0 ? ((taskTime / categoryTotalTime) * 100) : 0;
                        const taskPercentageDisplay = taskPercentage % 1 === 0 ? taskPercentage.toFixed(0) : taskPercentage.toFixed(1);
                        
                        html += `
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>${task.name} x ${task.count}</span>
                                <div class="flex items-center gap-4">
                                    <span class="w-12 text-right">${formatTimeHMM(taskTime)}</span>
                                    <span class="w-12 text-right text-gray-500">${taskPercentageDisplay}%</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            // Render Team Summary - Show stats for the selected date
            const dateToUse = selectedDate || document.getElementById('todayDate').value || new Date().toISOString().split('T')[0];
            
            // Filter entries for the selected date only
            const todayEntries = savedEntries.filter(entry => entry.date === dateToUse);
            
            const allStaffData = {};
            const allCategoryTotals = {};
            let allTotalTaskCount = 0;
            
            // Get unique staff members who have entries for this date
            const uniqueStaffWithEntries = new Set();
            
            todayEntries.forEach(entry => {
                // Check if this staff member exists and is active
                const staffMember = staffMembers.find(s => s.name === entry.staff && s.active);
                if (staffMember) {
                    uniqueStaffWithEntries.add(entry.staff);
                    
                    if (!allStaffData[entry.staff]) {
                        allStaffData[entry.staff] = {
                            totalMinutes: 0
                        };
                    }
                    
                    const task = findTaskById(entry.taskId);
                    const category = findTaskCategory(entry.taskId);
                    
                    allStaffData[entry.staff].totalMinutes += entry.count * task.duration;
                    
                    if (!allCategoryTotals[category]) {
                        allCategoryTotals[category] = {};
                    }
                    if (!allCategoryTotals[category][task.name]) {
                        allCategoryTotals[category][task.name] = 0;
                    }
                    allCategoryTotals[category][task.name] += entry.count;
                    allTotalTaskCount += entry.count;
                }
            });
            
            const activeStaffCount = uniqueStaffWithEntries.size;
            const totalStaff = staffMembers.filter(s => s.active).length;
            const teamProductivity = activeStaffCount > 0 ? Math.round((Object.values(allStaffData).reduce((sum, data) => sum + data.totalMinutes, 0) / (450 * activeStaffCount)) * 100) : 0;
            
            html += `
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Team Summary</h3>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-gray-900">${activeStaffCount}/${totalStaff}</div>
                            <div class="text-sm text-gray-600">Staff Members</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-gray-900">${teamProductivity}%</div>
                            <div class="text-sm text-gray-600">Team Productivity</div>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
            `;
            
            // Render category totals with percentages
            Object.entries(allCategoryTotals).forEach(([category, tasks]) => {
                const categoryCount = Object.values(tasks).reduce((sum, count) => sum + count, 0);
                const percentage = ((categoryCount / allTotalTaskCount) * 100);
                const percentageDisplay = percentage % 1 === 0 ? percentage.toFixed(0) : percentage.toFixed(1);
                
                // Calculate total time for this category across all staff
                let categoryTotalTime = 0;
                Object.entries(tasks).forEach(([taskName, taskCount]) => {
                    const task = findTaskByName(taskName);
                    if (task) {
                        categoryTotalTime += taskCount * task.duration;
                    }
                });
                
                html += `
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold text-gray-700">${category}</h4>
                            <span class="font-bold text-gray-700">${percentageDisplay}%</span>
                        </div>
                        <div class="ml-4 space-y-1">
                `;
                
                Object.entries(tasks).forEach(([taskName, taskCount]) => {
                    const task = findTaskByName(taskName);
                    if (task) {
                        const taskTime = taskCount * task.duration;
                        const taskPercentage = categoryTotalTime > 0 ? ((taskTime / categoryTotalTime) * 100) : 0;
                        const taskPercentageDisplay = taskPercentage % 1 === 0 ? taskPercentage.toFixed(0) : taskPercentage.toFixed(1);
                        
                        html += `
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>${taskName} x ${taskCount}</span>
                                <div class="flex items-center gap-4">
                                    <span class="w-12 text-right">${formatTimeHMM(taskTime)}</span>
                                    <span class="w-12 text-right text-gray-500">${taskPercentageDisplay}%</span>
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function findTaskCategory(taskId) {
            for (const [category, categoryTasks] of Object.entries(tasks)) {
                if (categoryTasks.find(t => t.id === taskId)) {
                    return category;
                }
            }
            return 'Unknown';
        }

        function findTaskCategoryByName(taskName) {
            for (const [category, categoryTasks] of Object.entries(tasks)) {
                if (categoryTasks.find(t => t.name === taskName)) {
                    return category;
                }
            }
            return 'Unknown';
        }
        
        function findTaskByName(taskName) {
            for (const category of Object.values(tasks)) {
                const task = category.find(t => t.name === taskName);
                if (task) return task;
            }
            return null;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-AU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function formatTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}h ${mins}m`;
        }

        function formatTimeNew(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (hours < 1) {
                return `${mins}min`;
            }
            return `${hours}h${mins}min`;
        }

        function formatTimeHMM(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}:${mins.toString().padStart(2, '0')}`;
        }
        
        // Staff Management Functions
        function renderStaffList() {
            const container = document.getElementById('staffList');
            const activeStaff = staffMembers.filter(s => s.active);
            
            if (activeStaff.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-gray-500">No staff members found</div>';
                return;
            }
            
            container.innerHTML = activeStaff.map(staff => `
                <div class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg" id="staff-item-${staff.id}">
                    <span class="font-medium text-gray-700">${staff.name}</span>
                    <div class="flex items-center gap-2">
                        <div class="confirm-delete hidden text-sm text-gray-600">
                            Are you sure?
                            <button onclick="confirmDelete('${staff.id}')" 
                                    class="ml-2 px-2 py-1 text-xs text-white bg-red-600 hover:bg-red-700 rounded transition-colors">
                                Yes
                            </button>
                            <button onclick="cancelDelete('${staff.id}')" 
                                    class="ml-1 px-2 py-1 text-xs text-gray-600 bg-gray-200 hover:bg-gray-300 rounded transition-colors">
                                No
                            </button>
                        </div>
                        <button onclick="deleteStaff('${staff.id}')" 
                                class="delete-btn px-3 py-1 text-sm text-red-600 hover:text-red-800 hover:bg-red-50 rounded transition-colors">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Update dropdowns
            updateStaffDropdowns();
        }
        
        function handleAddStaff(e) {
            e.preventDefault();
            
            const nameInput = document.getElementById('newStaffName');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Please enter a staff name');
                return;
            }
            
            // Generate ID from name
            const id = name.toLowerCase().replace(/\s+/g, '-');
            
            // Check if staff already exists
            if (staffMembers.find(s => s.id === id && s.active)) {
                alert('A staff member with this name already exists');
                return;
            }
            
            // Add new staff member
            staffMembers.push({
                id: id,
                name: name,
                active: true
            });
            
            // Clear form
            nameInput.value = '';
            
            // Re-render staff list
            renderStaffList();
        }
        
        function deleteStaff(staffId) {
            const staffItem = document.getElementById(`staff-item-${staffId}`);
            if (!staffItem) return;
            
            // Hide delete button and show confirmation
            staffItem.querySelector('.delete-btn').classList.add('hidden');
            staffItem.querySelector('.confirm-delete').classList.remove('hidden');
        }
        
        function confirmDelete(staffId) {
            const staff = staffMembers.find(s => s.id === staffId);
            if (!staff) return;
            
            // Mark as inactive instead of deleting (to preserve data integrity)
            staff.active = false;
            
            // Re-render staff list
            renderStaffList();
        }
        
        function cancelDelete(staffId) {
            const staffItem = document.getElementById(`staff-item-${staffId}`);
            if (!staffItem) return;
            
            // Show delete button and hide confirmation
            staffItem.querySelector('.delete-btn').classList.remove('hidden');
            staffItem.querySelector('.confirm-delete').classList.add('hidden');
        }
        
        function updateStaffDropdowns() {
            // Update staff dropdown in entry form
            const staffSelect = document.getElementById('staff');
            const currentValue = staffSelect.value;
            
            staffSelect.innerHTML = '<option value="">Select staff member</option>' +
                staffMembers
                    .filter(s => s.active)
                    .map(s => `<option value="${s.id}">${s.name}</option>`)
                    .join('');
            
            // Restore previous selection if still valid
            if (currentValue && staffMembers.find(s => s.id === currentValue && s.active)) {
                staffSelect.value = currentValue;
            }
            
            // Update staff filter in admin
            const staffFilter = document.getElementById('staffFilter');
            const filterValue = staffFilter.value;
            
            staffFilter.innerHTML = '<option value="">All Staff</option>' +
                staffMembers
                    .filter(s => s.active)
                    .map(s => `<option value="${s.name}">${s.name}</option>`)
                    .join('');
            
            // Restore previous selection if still valid
            if (filterValue && staffMembers.find(s => s.name === filterValue && s.active)) {
                staffFilter.value = filterValue;
            }
        }
        
        function getStaffName(staffId) {
            const staff = staffMembers.find(s => s.id === staffId);
            return staff ? staff.name : staffId;
        }
        
        // Task Calibration Functions
        function renderTaskCalibration() {
            const container = document.getElementById('taskCalibrationList');
            container.innerHTML = '';
            
            // Add initial drop indicator for the first position
            const firstDropIndicator = document.createElement('div');
            firstDropIndicator.className = 'drop-indicator category-drop-indicator';
            firstDropIndicator.id = 'category-drop-first';
            firstDropIndicator.dataset.position = 'first';
            container.appendChild(firstDropIndicator);
            
            Object.entries(tasks).forEach(([category, categoryTasks], categoryIndex) => {
                const categoryWrapper = document.createElement('div');
                categoryWrapper.className = 'category-wrapper';
                
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'border border-gray-200 rounded-lg p-4 draggable category-draggable';
                categoryDiv.draggable = true;
                categoryDiv.dataset.category = category;
                categoryDiv.dataset.categoryIndex = categoryIndex;
                
                let categoryHtml = `
                    <div class="flex items-center justify-between mb-3">
                        <div id="category-header-${category.replace(/[^a-zA-Z0-9]/g, '_')}" class="flex items-center gap-3 flex-1">
                            <h3 class="text-lg font-semibold text-gray-900 bg-gray-50 px-3 py-2 rounded">${category}</h3>
                        </div>
                        <div id="category-edit-${category.replace(/[^a-zA-Z0-9]/g, '_')}" class="hidden flex items-center gap-3 flex-1">
                            <input type="text" 
                                   id="category-name-${category.replace(/[^a-zA-Z0-9]/g, '_')}" 
                                   value="${category}" 
                                   class="text-lg font-semibold px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button onclick="saveCategoryEdit('${category}')" 
                                    class="text-green-600 hover:text-green-800 text-sm">
                                Save
                            </button>
                            <button onclick="cancelCategoryEdit('${category}')" 
                                    class="text-gray-600 hover:text-gray-800 text-sm">
                                Cancel
                            </button>
                        </div>
                        <div class="flex items-center gap-6">
                            <div class="w-20"></div>
                            <div class="flex items-center gap-2" id="category-actions-${category.replace(/[^a-zA-Z0-9]/g, '_')}">
                                <button onclick="editCategory('${category}')" 
                                        class="text-blue-600 hover:text-blue-800 text-sm">
                                    Edit
                                </button>
                                <button onclick="deleteCategory('${category}')" 
                                        class="text-red-600 hover:text-red-800 text-sm">
                                    Delete
                                </button>
                            </div>
                            <span class="drag-handle">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                </svg>
                            </span>
                        </div>
                    </div>
                    <div class="space-y-2" data-category="${category}">
                `;
                
                // Add first task drop indicator
                categoryHtml += `<div class="drop-indicator task-drop-indicator" data-category="${category}" data-position="first"></div>`;
                
                categoryTasks.forEach((task, taskIndex) => {
                    categoryHtml += `
                        <div class="flex items-center justify-between py-2 px-3 bg-white border border-gray-100 rounded draggable task-draggable" 
                             id="task-row-${task.id}" 
                             draggable="true" 
                             data-task-id="${task.id}"
                             data-task-index="${taskIndex}">
                            <div class="flex items-center gap-2 flex-1">
                                <span class="text-sm font-medium text-gray-700">${task.name}</span>
                            </div>
                            <div class="flex items-center gap-6">
                                <div class="flex items-center gap-2" id="task-display-${task.id}">
                                    <div class="time-input-group">
                                        <span class="w-12 text-right">${task.duration}</span>
                                        <span class="text-sm text-gray-500">min</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 hidden" id="task-edit-${task.id}">
                                    <div class="time-input-group">
                                        <input type="number" 
                                               id="duration-edit-${task.id}" 
                                               value="${task.duration}" 
                                               min="1" 
                                               class="w-12 px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <span class="text-sm text-gray-500">min</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2" id="task-actions-${task.id}">
                                    <button onclick="editTask('${task.id}')" 
                                            class="text-blue-600 hover:text-blue-800 text-sm">
                                        Edit
                                    </button>
                                    <button onclick="deleteTask('${task.id}')" 
                                            class="text-red-600 hover:text-red-800 text-sm">
                                        Delete
                                    </button>
                                </div>
                                <div class="flex items-center gap-2 hidden" id="task-save-actions-${task.id}">
                                    <button onclick="saveTaskEdit('${task.id}')" 
                                            class="text-green-600 hover:text-green-800 text-sm">
                                        Save
                                    </button>
                                    <button onclick="cancelTaskEdit('${task.id}')" 
                                            class="text-gray-600 hover:text-gray-800 text-sm">
                                        Cancel
                                    </button>
                                </div>
                                <span class="drag-handle">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                    </svg>
                                </span>
                            </div>
                        </div>
                        <div class="drop-indicator task-drop-indicator" data-category="${category}" data-position="after-${task.id}"></div>
                    `;
                });
                
                categoryHtml += `
                    </div>
                `;
                
                categoryDiv.innerHTML = categoryHtml;
                categoryWrapper.appendChild(categoryDiv);
                
                // Add drop indicator after this category
                const dropIndicator = document.createElement('div');
                dropIndicator.className = 'drop-indicator category-drop-indicator';
                dropIndicator.id = `category-drop-${categoryIndex}`;
                dropIndicator.dataset.position = `after-${category}`;
                categoryWrapper.appendChild(dropIndicator);
                
                container.appendChild(categoryWrapper);
            });
            
            // Initialize drag and drop after DOM is updated
            setTimeout(() => {
                initializeDragAndDrop();
            }, 0);
        }
        
        function updateTaskDuration(taskId, newDuration) {
            const duration = parseInt(newDuration);
            if (isNaN(duration) || duration < 1) {
                alert('Duration must be at least 1 minute');
                // Reset to original value
                const task = findTaskById(taskId);
                if (task) {
                    document.getElementById(`duration-${taskId}`).value = task.duration;
                }
                return;
            }
            
            // Update the task duration
            for (const category of Object.values(tasks)) {
                const task = category.find(t => t.id === taskId);
                if (task) {
                    task.duration = duration;
                    break;
                }
            }
            
            // Show success feedback
            const input = document.getElementById(`duration-${taskId}`);
            input.style.backgroundColor = '#d1fae5';
            setTimeout(() => {
                input.style.backgroundColor = '';
            }, 1000);
        }
        
        function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) {
                return;
            }
            
            // Find and remove the task
            for (const [category, categoryTasks] of Object.entries(tasks)) {
                const index = categoryTasks.findIndex(t => t.id === taskId);
                if (index !== -1) {
                    categoryTasks.splice(index, 1);
                    break;
                }
            }
            
            // Re-render the task calibration list
            renderTaskCalibration();
            
            // Also re-render task categories in the main form
            renderTaskCategories();
        }
        
        function showAddTaskModal() {
            document.getElementById('addTaskModal').classList.remove('hidden');
        }
        
        function hideAddTaskModal() {
            document.getElementById('addTaskModal').classList.add('hidden');
            // Clear form
            document.getElementById('addTaskForm').reset();
        }
        
        function handleAddTask(event) {
            event.preventDefault();
            
            const category = document.getElementById('newTaskCategory').value;
            const name = document.getElementById('newTaskName').value.trim();
            const duration = parseInt(document.getElementById('newTaskDuration').value);
            
            if (!category || !name || !duration) {
                alert('Please fill in all fields');
                return;
            }
            
            // Generate new task ID
            const maxId = Math.max(...Object.values(tasks).flat().map(t => parseInt(t.id)));
            const newId = (maxId + 1).toString();
            
            // Add the new task
            if (!tasks[category]) {
                tasks[category] = [];
            }
            
            tasks[category].push({
                id: newId,
                name: name,
                duration: duration
            });
            
            // Hide modal
            hideAddTaskModal();
            
            // Re-render both task calibration and task categories
            renderTaskCalibration();
            renderTaskCategories();
        }
        
        // Create Category Functions
        function showCreateCategoryModal() {
            document.getElementById('createCategoryModal').classList.remove('hidden');
        }
        
        function hideCreateCategoryModal() {
            document.getElementById('createCategoryModal').classList.add('hidden');
            // Clear form
            document.getElementById('createCategoryForm').reset();
        }
        
        function handleCreateCategory(event) {
            event.preventDefault();
            
            const categoryName = document.getElementById('newCategoryName').value.trim().toUpperCase();
            
            if (!categoryName) {
                alert('Please enter a category name');
                return;
            }
            
            // Check if category already exists
            if (tasks.hasOwnProperty(categoryName)) {
                alert('This category already exists');
                return;
            }
            
            // Create new category with empty tasks array
            tasks[categoryName] = [];
            
            // Update the Add Task modal dropdown
            updateTaskCategoryDropdown();
            
            // Hide modal
            hideCreateCategoryModal();
            
            // Re-render both task calibration and task categories
            renderTaskCalibration();
            renderTaskCategories();
        }
        
        function updateTaskCategoryDropdown() {
            const select = document.getElementById('newTaskCategory');
            select.innerHTML = '<option value="">Select category</option>' +
                Object.keys(tasks).map(category => 
                    `<option value="${category}">${category}</option>`
                ).join('');
        }
        
        // Category Edit/Delete Functions
        function editCategory(category) {
            const categoryId = category.replace(/[^a-zA-Z0-9]/g, '_');
            document.getElementById(`category-header-${categoryId}`).classList.add('hidden');
            document.getElementById(`category-edit-${categoryId}`).classList.remove('hidden');
            document.getElementById(`category-actions-${categoryId}`).classList.add('hidden');
            document.getElementById(`category-name-${categoryId}`).focus();
        }
        
        function saveCategoryEdit(oldCategory) {
            const categoryId = oldCategory.replace(/[^a-zA-Z0-9]/g, '_');
            const newCategoryName = document.getElementById(`category-name-${categoryId}`).value.trim().toUpperCase();
            
            if (!newCategoryName) {
                alert('Category name cannot be empty');
                return;
            }
            
            if (newCategoryName !== oldCategory && tasks.hasOwnProperty(newCategoryName)) {
                alert('This category name already exists');
                return;
            }
            
            if (newCategoryName === oldCategory) {
                cancelCategoryEdit(oldCategory);
                return;
            }
            
            // Preserve the order by creating a new object with renamed key
            const newTasks = {};
            for (const [key, value] of Object.entries(tasks)) {
                if (key === oldCategory) {
                    newTasks[newCategoryName] = value;
                } else {
                    newTasks[key] = value;
                }
            }
            
            // Replace the entire tasks object to maintain order
            Object.keys(tasks).forEach(key => delete tasks[key]);
            Object.assign(tasks, newTasks);
            
            // Update the Add Task modal dropdown
            updateTaskCategoryDropdown();
            
            // Re-render both task calibration and task categories
            renderTaskCalibration();
            renderTaskCategories();
        }
        
        function cancelCategoryEdit(category) {
            const categoryId = category.replace(/[^a-zA-Z0-9]/g, '_');
            document.getElementById(`category-header-${categoryId}`).classList.remove('hidden');
            document.getElementById(`category-edit-${categoryId}`).classList.add('hidden');
            // Reset the input value
            document.getElementById(`category-name-${categoryId}`).value = category;
        }
        
        function deleteCategory(category) {
            const categoryTasks = tasks[category] || [];
            
            if (categoryTasks.length > 0) {
                if (!confirm(`This category contains ${categoryTasks.length} task(s). Deleting the category will also delete all tasks in it. Are you sure?`)) {
                    return;
                }
            } else {
                if (!confirm('Are you sure you want to delete this category?')) {
                    return;
                }
            }
            
            // Delete the category
            delete tasks[category];
            
            // Update the Add Task modal dropdown
            updateTaskCategoryDropdown();
            
            // Re-render both task calibration and task categories
            renderTaskCalibration();
            renderTaskCategories();
        }
        
        // Task Edit Functions
        function editTask(taskId) {
            document.getElementById(`task-display-${taskId}`).classList.add('hidden');
            document.getElementById(`task-edit-${taskId}`).classList.remove('hidden');
            document.getElementById(`task-actions-${taskId}`).classList.add('hidden');
            document.getElementById(`task-save-actions-${taskId}`).classList.remove('hidden');
            document.getElementById(`duration-edit-${taskId}`).focus();
        }
        
        function saveTaskEdit(taskId) {
            const newDuration = parseInt(document.getElementById(`duration-edit-${taskId}`).value);
            
            if (isNaN(newDuration) || newDuration < 1) {
                alert('Duration must be at least 1 minute');
                return;
            }
            
            // Update the task duration
            for (const category of Object.values(tasks)) {
                const task = category.find(t => t.id === taskId);
                if (task) {
                    task.duration = newDuration;
                    break;
                }
            }
            
            // Update the display
            document.getElementById(`task-display-${taskId}`).querySelector('span').textContent = newDuration;
            
            // Switch back to display mode
            cancelTaskEdit(taskId);
            
            // Show success feedback
            const displayElement = document.getElementById(`task-display-${taskId}`);
            displayElement.style.backgroundColor = '#d1fae5';
            setTimeout(() => {
                displayElement.style.backgroundColor = '';
            }, 1000);
        }
        
        function cancelTaskEdit(taskId) {
            const task = findTaskById(taskId);
            if (task) {
                document.getElementById(`duration-edit-${taskId}`).value = task.duration;
            }
            
            document.getElementById(`task-display-${taskId}`).classList.remove('hidden');
            document.getElementById(`task-edit-${taskId}`).classList.add('hidden');
            document.getElementById(`task-actions-${taskId}`).classList.remove('hidden');
            document.getElementById(`task-save-actions-${taskId}`).classList.add('hidden');
        }
        
        // Update switchTab function to render task calibration when switching to that tab
        const originalSwitchTab = switchTab;
        switchTab = function(tabId) {
            originalSwitchTab(tabId);
            
            // Render task calibration when switching to that tab
            if (tabId === 'task-calibration') {
                renderTaskCalibration();
            }
        };
        
        // Global drag state
        let draggedElement = null;
        let draggedType = null;
        let draggedData = null;
        
        // Drag and Drop Functions
        function initializeDragAndDrop() {
            // Clear all existing indicators
            function clearDropIndicators() {
                document.querySelectorAll('.drop-indicator').forEach(indicator => {
                    indicator.classList.remove('active');
                });
            }
            
            // Show drop indicator
            function showDropIndicator(element) {
                clearDropIndicators();
                if (element) {
                    element.classList.add('active');
                }
            }
            
            // Use event delegation for drag events
            const container = document.getElementById('taskCalibrationList');
            if (!container) return;
            
            // Remove any existing listeners
            container.removeEventListener('dragstart', handleDragStart);
            container.removeEventListener('dragover', handleDragOver);
            container.removeEventListener('drop', handleDrop);
            container.removeEventListener('dragend', handleDragEnd);
            container.removeEventListener('dragenter', handleDragEnter);
            
            // Add new listeners
            container.addEventListener('dragstart', handleDragStart);
            container.addEventListener('dragover', handleDragOver);
            container.addEventListener('drop', handleDrop);
            container.addEventListener('dragend', handleDragEnd);
            container.addEventListener('dragenter', handleDragEnter);
            
            function handleDragStart(e) {
                const draggable = e.target.closest('.draggable');
                if (!draggable) return;
                
                draggedElement = draggable;
                draggable.classList.add('dragging');
                
                if (draggable.dataset.category) {
                    draggedType = 'category';
                    draggedData = draggable.dataset.category;
                } else if (draggable.dataset.taskId) {
                    draggedType = 'task';
                    draggedData = draggable.dataset.taskId;
                }
                
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', '');
            }
            
            function handleDragEnter(e) {
                e.preventDefault();
                
                const target = e.target.closest('.drop-indicator, .draggable');
                if (!target || target === draggedElement) return;
                
                // Show appropriate drop indicator based on what's being dragged
                if (target.classList.contains('drop-indicator')) {
                    // Only show category drop indicators when dragging categories
                    if (draggedType === 'category' && target.classList.contains('category-drop-indicator')) {
                        showDropIndicator(target);
                    }
                    // Only show task drop indicators when dragging tasks
                    else if (draggedType === 'task' && target.classList.contains('task-drop-indicator')) {
                        showDropIndicator(target);
                    }
                } else if (target.classList.contains('draggable')) {
                    // For categories being dragged over categories
                    if (draggedType === 'category' && target.classList.contains('category-draggable')) {
                        // Find the category drop indicator before this category
                        const categoryWrapper = target.closest('.category-wrapper');
                        if (categoryWrapper) {
                            const prevWrapper = categoryWrapper.previousElementSibling;
                            if (prevWrapper && prevWrapper.classList.contains('drop-indicator')) {
                                showDropIndicator(prevWrapper);
                            }
                        }
                    }
                    // For tasks being dragged over tasks
                    else if (draggedType === 'task' && target.classList.contains('task-draggable')) {
                        // Find the task drop indicator before this task
                        const dropIndicator = target.previousElementSibling;
                        if (dropIndicator && dropIndicator.classList.contains('task-drop-indicator')) {
                            showDropIndicator(dropIndicator);
                        }
                    }
                }
            }
            
            function handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                return false;
            }
            
            function handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const dropTarget = e.target.closest('.drop-indicator, .draggable');
                if (!dropTarget || dropTarget === draggedElement) {
                    clearDropIndicators();
                    return false;
                }
                
                let moved = false;
                
                if (dropTarget.classList.contains('drop-indicator')) {
                    // Handle category drop indicators
                    if (dropTarget.classList.contains('category-drop-indicator') && draggedType === 'category') {
                        const position = dropTarget.dataset.position;
                        
                        if (position === 'first') {
                            // Move to the beginning
                            moved = moveCategoryToBeginning(draggedData);
                        } else if (position && position.startsWith('after-')) {
                            const afterCategory = position.substring(6);
                            // Move after the specified category
                            moved = moveCategoryAfter(draggedData, afterCategory);
                        }
                    }
                    // Handle task drop indicators
                    else if (dropTarget.classList.contains('task-drop-indicator') && draggedType === 'task') {
                        const targetCategory = dropTarget.dataset.category;
                        const position = dropTarget.dataset.position;
                        
                        if (position === 'first') {
                            // Move to beginning of category
                            moved = moveTaskToBeginningOfCategory(draggedData, targetCategory);
                        } else if (position && position.startsWith('after-')) {
                            const afterTaskId = position.substring(6);
                            // Move after the specified task
                            moved = moveTaskAfter(draggedData, afterTaskId, targetCategory);
                        }
                    }
                } else if (dropTarget.classList.contains('draggable')) {
                    // Dropping directly on elements (fallback)
                    if (dropTarget.dataset.category && draggedType === 'category') {
                        moved = moveCategoryBefore(draggedData, dropTarget.dataset.category);
                    } else if (dropTarget.dataset.taskId && draggedType === 'task') {
                        const targetCategory = findTaskCategory(dropTarget.dataset.taskId);
                        moved = moveTaskBefore(draggedData, dropTarget.dataset.taskId, targetCategory);
                    }
                }
                
                clearDropIndicators();
                return false;
            }
            
            function handleDragEnd(e) {
                if (draggedElement) {
                    draggedElement.classList.remove('dragging');
                }
                clearDropIndicators();
                draggedElement = null;
                draggedType = null;
                draggedData = null;
            }
            
            // Helper functions for moving elements
            function moveCategoryToBeginning(draggedCategory) {
                const categoriesArray = Object.entries(tasks);
                const draggedIndex = categoriesArray.findIndex(([cat]) => cat === draggedCategory);
                
                if (draggedIndex !== -1 && draggedIndex !== 0) {
                    const [removed] = categoriesArray.splice(draggedIndex, 1);
                    categoriesArray.unshift(removed);
                    rebuildTasksObject(categoriesArray);
                    return true;
                }
                return false;
            }
            
            function moveCategoryAfter(draggedCategory, afterCategory) {
                if (draggedCategory === afterCategory) return false;
                
                const categoriesArray = Object.entries(tasks);
                const draggedIndex = categoriesArray.findIndex(([cat]) => cat === draggedCategory);
                const afterIndex = categoriesArray.findIndex(([cat]) => cat === afterCategory);
                
                if (draggedIndex !== -1 && afterIndex !== -1) {
                    const [removed] = categoriesArray.splice(draggedIndex, 1);
                    const insertIndex = draggedIndex < afterIndex ? afterIndex : afterIndex + 1;
                    categoriesArray.splice(insertIndex, 0, removed);
                    
                    rebuildTasksObject(categoriesArray);
                    return true;
                }
                return false;
            }
            
            function moveCategoryBefore(draggedCategory, targetCategory) {
                if (draggedCategory === targetCategory) return false;
                
                const categoriesArray = Object.entries(tasks);
                const draggedIndex = categoriesArray.findIndex(([cat]) => cat === draggedCategory);
                const targetIndex = categoriesArray.findIndex(([cat]) => cat === targetCategory);
                
                if (draggedIndex !== -1 && targetIndex !== -1) {
                    const [removed] = categoriesArray.splice(draggedIndex, 1);
                    const newTargetIndex = draggedIndex < targetIndex ? targetIndex - 1 : targetIndex;
                    categoriesArray.splice(newTargetIndex, 0, removed);
                    
                    rebuildTasksObject(categoriesArray);
                    return true;
                }
                return false;
            }
            
            function moveCategoryToEnd(draggedCategory) {
                const categoriesArray = Object.entries(tasks);
                const draggedIndex = categoriesArray.findIndex(([cat]) => cat === draggedCategory);
                
                if (draggedIndex !== -1 && draggedIndex !== categoriesArray.length - 1) {
                    const [removed] = categoriesArray.splice(draggedIndex, 1);
                    categoriesArray.push(removed);
                    rebuildTasksObject(categoriesArray);
                    return true;
                }
                return false;
            }
            
            function moveTaskToBeginningOfCategory(draggedTaskId, targetCategory) {
                // Find and remove dragged task
                let draggedTask = null;
                
                for (const [category, categoryTasks] of Object.entries(tasks)) {
                    const taskIndex = categoryTasks.findIndex(t => t.id === draggedTaskId);
                    if (taskIndex !== -1) {
                        draggedTask = categoryTasks[taskIndex];
                        // If already at beginning of same category, don't move
                        if (category === targetCategory && taskIndex === 0) {
                            return false;
                        }
                        categoryTasks.splice(taskIndex, 1);
                        break;
                    }
                }
                
                if (draggedTask && tasks[targetCategory]) {
                    tasks[targetCategory].unshift(draggedTask);
                    renderTaskCalibration();
                    renderTaskCategories();
                    return true;
                }
                return false;
            }
            
            function moveTaskAfter(draggedTaskId, afterTaskId, targetCategory) {
                if (draggedTaskId === afterTaskId) return false;
                
                // Find and remove dragged task
                let draggedTask = null;
                
                for (const [category, categoryTasks] of Object.entries(tasks)) {
                    const taskIndex = categoryTasks.findIndex(t => t.id === draggedTaskId);
                    if (taskIndex !== -1) {
                        draggedTask = categoryTasks[taskIndex];
                        categoryTasks.splice(taskIndex, 1);
                        break;
                    }
                }
                
                if (draggedTask && tasks[targetCategory]) {
                    const targetTasks = tasks[targetCategory];
                    const afterIndex = targetTasks.findIndex(t => t.id === afterTaskId);
                    
                    if (afterIndex !== -1) {
                        targetTasks.splice(afterIndex + 1, 0, draggedTask);
                    } else {
                        targetTasks.push(draggedTask);
                    }
                    
                    renderTaskCalibration();
                    renderTaskCategories();
                    return true;
                }
                return false;
            }
            
            function moveTaskBefore(draggedTaskId, targetTaskId, targetCategory) {
                if (draggedTaskId === targetTaskId) return false;
                
                // Find and remove dragged task
                let draggedTask = null;
                let sourceCategory = null;
                
                for (const [category, categoryTasks] of Object.entries(tasks)) {
                    const taskIndex = categoryTasks.findIndex(t => t.id === draggedTaskId);
                    if (taskIndex !== -1) {
                        draggedTask = categoryTasks[taskIndex];
                        sourceCategory = category;
                        categoryTasks.splice(taskIndex, 1);
                        break;
                    }
                }
                
                if (draggedTask && tasks[targetCategory]) {
                    const targetTasks = tasks[targetCategory];
                    const targetIndex = targetTasks.findIndex(t => t.id === targetTaskId);
                    
                    if (targetIndex !== -1) {
                        targetTasks.splice(targetIndex, 0, draggedTask);
                    } else {
                        targetTasks.push(draggedTask);
                    }
                    
                    renderTaskCalibration();
                    renderTaskCategories();
                    return true;
                }
                return false;
            }
            
            function moveTaskToEndOfCategory(draggedTaskId, targetCategory) {
                // Find and remove dragged task
                let draggedTask = null;
                let sourceCategory = null;
                
                for (const [category, categoryTasks] of Object.entries(tasks)) {
                    const taskIndex = categoryTasks.findIndex(t => t.id === draggedTaskId);
                    if (taskIndex !== -1) {
                        draggedTask = categoryTasks[taskIndex];
                        sourceCategory = category;
                        
                        // If moving within same category and already at end, don't move
                        if (category === targetCategory && taskIndex === categoryTasks.length - 1) {
                            return false;
                        }
                        
                        categoryTasks.splice(taskIndex, 1);
                        break;
                    }
                }
                
                if (draggedTask && tasks[targetCategory]) {
                    tasks[targetCategory].push(draggedTask);
                    renderTaskCalibration();
                    renderTaskCategories();
                    return true;
                }
                return false;
            }
            
            function rebuildTasksObject(categoriesArray) {
                const newTasks = {};
                categoriesArray.forEach(([cat, catTasks]) => {
                    newTasks[cat] = catTasks;
                });
                
                // Clear and rebuild tasks object
                Object.keys(tasks).forEach(key => delete tasks[key]);
                Object.assign(tasks, newTasks);
                
                renderTaskCalibration();
                renderTaskCategories();
            }
        }
    </script>
</body>
</html>
